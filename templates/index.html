<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="StudyMate AI - Your intelligent learning companion with dark aesthetic">
    <meta name="theme-color" content="#0a0a0a">
    <title>StudyMate AI - Dark Learning Companion</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/static/manifest.json">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- CSS -->
    <link rel="stylesheet" href="/static/css/dark-theme.css">
    
    <!-- Preload critical resources -->
    <link rel="preload" href="/static/js/main.js" as="script">
    <link rel="preload" href="/static/js/utils.js" as="script">
</head>
<body class="no-chat">
    <!-- App Container -->
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <!-- Sidebar Header -->
            <div class="sidebar-header">
                <div class="logo">
                    <i class="fas fa-brain"></i>
                    <span>StudyMate AI</span>
                </div>
                <button class="sidebar-toggle mobile-only" onclick="toggleSidebar()" aria-label="Close sidebar">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- Mode Selector -->
            <div class="mode-selector">
                <div class="mode-option active" data-mode="chat" onclick="switchMode('chat')" role="button" tabindex="0">
                    <i class="fas fa-comments"></i>
                    <span>Chat</span>
                </div>
                <div class="mode-option" data-mode="tutor" onclick="switchMode('tutor')" role="button" tabindex="0">
                    <i class="fas fa-chalkboard-teacher"></i>
                    <span>Tutor</span>
                </div>
                <div class="mode-option" data-mode="notes" onclick="switchMode('notes')" role="button" tabindex="0">
                    <i class="fas fa-sticky-note"></i>
                    <span>Notes</span>
                </div>
                <div class="mode-option" data-mode="quiz" onclick="switchMode('quiz')" role="button" tabindex="0">
                    <i class="fas fa-question-circle"></i>
                    <span>Quiz</span>
                </div>
            </div>
            
            <!-- Sessions Section -->
            <div class="sidebar-section">
                <div class="section-header">
                    <h3>
                        <i class="fas fa-history"></i>
                        Chats
                    </h3>
                </div>
                <div class="sessions-list" id="sessionsList">
                    <!-- Sessions will be loaded here -->
                    <div class="empty-state">
                        <i class="fas fa-comments"></i>
                        <p>No chat sessions yet</p>
                        <small>Start a new conversation to begin</small>
                    </div>
                </div>
                <div class="sessions-actions">
                    <button class="btn btn-primary" style="width:100%;" onclick="showSessionNameModal()" aria-label="Create new chat">
                        New Chat
                    </button>
                </div>
            </div>
            

            
            <!-- Quick Actions Section -->
            <div class="sidebar-section">
                <div class="section-header">
                    <h3>
                        <i class="fas fa-bolt"></i>
                        Quick Actions
                    </h3>
                </div>
                <div class="quick-actions-list">
                    <button class="quick-action-btn" onclick="sendQuickMessage('Explain a complex concept to me')" tabindex="0">
                        <i class="fas fa-lightbulb"></i>
                        <span>Explain Concepts</span>
                    </button>
                    <button class="quick-action-btn" onclick="sendQuickMessage('Generate study notes for me')" tabindex="0">
                        <i class="fas fa-file-alt"></i>
                        <span>Generate Notes</span>
                    </button>
                    <button class="quick-action-btn" onclick="sendQuickMessage('Create a quiz to test my knowledge')" tabindex="0">
                        <i class="fas fa-question-circle"></i>
                        <span>Create Quiz</span>
                    </button>
                </div>
                <div class="quick-actions-extra">
                    <button class="quick-action-btn study-planning" onclick="sendQuickMessage('Help me plan my study schedule')" tabindex="0">
                        <i class="fas fa-calendar-check"></i>
                        <span>Study Planning</span>
                    </button>
                </div>
            </div>
            
            <!-- Settings Footer -->
            <div class="sidebar-footer">
                <div class="settings-section">
                    <button class="settings-btn" onclick="toggleVoiceOutput()" title="Toggle Voice Output" aria-label="Toggle voice output">
                        <i class="fas fa-volume-up" id="voiceOutputIcon"></i>
                    </button>
                    <button class="settings-btn" onclick="showVoiceSettings()" title="Voice Settings" aria-label="Voice settings">
                        <i class="fas fa-microphone-alt"></i>
                    </button>

                    <button class="settings-btn" onclick="showColorPicker()" title="Personalize Colors" aria-label="Personalize colors">
                        <i class="fas fa-palette"></i>
                    </button>
                    <button class="settings-btn" onclick="clearChat()" title="Clear Chat" aria-label="Clear current chat">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            </div>
        </aside>
        
        <!-- Main Content -->
        <main class="main-content">
            <!-- Chat Header -->
            <header class="chat-header">
                <div class="header-left">
                    <button class="sidebar-toggle mobile-only" onclick="toggleSidebar()" aria-label="Open sidebar">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="session-info">
                        <div class="session-title-row">
                            <h2 id="sessionTitle" class="editable-title" onclick="editSessionTitle()" title="Click to rename session">Chat 1</h2>
                            <button class="download-chat-btn" onclick="downloadFullChat()" title="Download Full Chat as PDF" aria-label="Download chat">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                        <span class="session-mode" id="sessionMode">Chat Mode</span>
                    </div>
                </div>
                <div class="header-right">
                    <div class="ai-status ready" id="aiStatus">AI Ready</div>
                    <div class="mode-indicator" id="modeIndicator">
                        <i class="fas fa-comments"></i>
                        <span>Chat</span>
                    </div>
                </div>
            </header>
            
            <!-- Messages Container -->
            <div class="messages-container" id="messagesContainer">
                <!-- File Drop Overlay -->
                <div class="chat-drop-overlay" id="chatDropOverlay" style="display: none;">
                    <div class="drop-content">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <h3>Drop your files here</h3>
                        <p>PDF, DOCX, PPTX, TXT files supported</p>
                    </div>
                </div>
                
                <!-- Welcome Message -->
                <div class="welcome-message" id="welcomeMessage">
                    <div class="welcome-content">
                        <div class="welcome-icon">
                            <i class="fas fa-brain"></i>
                        </div>
                        <h3>Welcome to StudyMate AI</h3>
                        <p>Your intelligent learning companion with advanced AI capabilities. Drag & drop documents here or use the attachment button to upload files, then ask questions!</p>
                        
                        <div class="upload-hint">
                            <i class="fas fa-info-circle"></i>
                            <span>Tip: Drag & drop files directly into this chat area to upload them instantly</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Typing Indicator -->
            <div class="typing-indicator" id="typingIndicator" style="display: none;" role="status" aria-label="AI is typing">
                <div class="typing-avatar">
                    <i class="fas fa-brain"></i>
                </div>
                <div class="typing-content">
                    <div class="typing-bubble">
                        <div class="typing-dots">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Input Area -->
            <div class="input-area">
                <!-- Message Input -->
                <div class="input-container">
                    <div class="input-wrapper">
                        <textarea 
                            id="messageInput" 
                            placeholder="Ask me anything about your studies..."
                            onkeydown="handleKeyDown(event)"
                            oninput="adjustTextareaHeight(this); updateSendButton();"
                            rows="1"
                            aria-label="Message input"
                            autocomplete="off"
                            spellcheck="true"
                        ></textarea>
                        
                        <div class="input-actions">
                            <button class="input-btn" id="voiceBtn" onclick="toggleVoiceInput()" title="Voice Input (Ctrl+Shift+V)" aria-label="Voice input" style="display: flex;">
                                <i class="fas fa-microphone"></i>
                            </button>
                            <button class="input-btn" onclick="document.getElementById('fileInput').click()" title="Upload File" aria-label="Upload file">
                                <i class="fas fa-paperclip"></i>
                            </button>
                            <button class="input-btn" onclick="showEmojiPicker()" title="Add Emoji" aria-label="Add emoji">
                                <i class="fas fa-smile"></i>
                            </button>
                            <button class="send-btn" id="sendBtn" onclick="sendMessage()" disabled aria-label="Send message">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Hidden File Input -->
    <input type="file" id="fileInput" multiple accept=".pdf,.docx,.pptx,.txt" style="display: none;" aria-hidden="true">
    
    <!-- Color Picker Modal -->
    <div id="colorPickerModal" class="modal-overlay" style="display: none;">
        <div class="modal color-picker-modal">
            <div class="modal-header">
                <h3>ðŸŽ¨ Personalize Your Colors</h3>
                <button class="modal-close" onclick="closeColorPicker()" aria-label="Close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="color-section">
                    <label>Accent Color (Buttons & Highlights)</label>
                    <div class="color-input-group">
                        <input type="color" id="accentColorPicker" value="#3b82f6">
                        <span class="color-preview" id="accentPreview"></span>
                    </div>
                </div>
                
                <div class="color-section">
                    <label>Background Tint</label>
                    <div class="color-input-group">
                        <input type="color" id="backgroundColorPicker" value="#0f172a">
                        <span class="color-preview" id="backgroundPreview"></span>
                    </div>
                </div>
                
                <div class="color-section">
                    <label>Text Highlight Color</label>
                    <div class="color-input-group">
                        <input type="color" id="highlightColorPicker" value="#fbbf24">
                        <span class="color-preview" id="highlightPreview"></span>
                    </div>
                </div>
                
                <div class="preset-colors">
                    <label>Quick Presets:</label>
                    <div class="preset-grid">
                        <button class="preset-btn" onclick="applyPreset('blue')" style="background: linear-gradient(45deg, #3b82f6, #1e40af)">Blue</button>
                        <button class="preset-btn" onclick="applyPreset('purple')" style="background: linear-gradient(45deg, #8b5cf6, #7c3aed)">Purple</button>
                        <button class="preset-btn" onclick="applyPreset('green')" style="background: linear-gradient(45deg, #10b981, #059669)">Green</button>
                        <button class="preset-btn" onclick="applyPreset('orange')" style="background: linear-gradient(45deg, #f59e0b, #d97706)">Orange</button>
                        <button class="preset-btn" onclick="applyPreset('pink')" style="background: linear-gradient(45deg, #ec4899, #db2777)">Pink</button>
                        <button class="preset-btn" onclick="applyPreset('red')" style="background: linear-gradient(45deg, #ef4444, #dc2626)">Red</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="resetColors()">Reset to Default</button>
                <button class="btn btn-primary" onclick="applyColors()">Apply Colors</button>
            </div>
        </div>
    </div>
    
    <!-- Notifications Container -->
    <div id="notificationsContainer" class="notifications-container" role="region" aria-label="Notifications"></div>
    
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner">
            <i class="fas fa-brain"></i>
            <span>Processing...</span>
        </div>
    </div>
    
    <!-- JavaScript -->
    <script src="/static/js/utils.js"></script>
    <script src="/static/js/themes.js"></script>
    <script src="/static/js/voice.js"></script>
    <script src="/static/js/documents.js"></script>
    <script src="/static/js/sessions.js"></script>
    <script src="/static/js/main.js"></script>
    
    <script>
        // Initialize StudyMate when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ðŸ§  Initializing StudyMate AI Dark Edition...');
            
            // Initialize all components
            initializeApp();
            
            // Add keyboard shortcuts
            setupKeyboardShortcuts();
            
            // Initialize accessibility features
            setupAccessibility();
            
            console.log('âœ… StudyMate AI Dark Edition ready!');
        });
        
        // Keyboard shortcuts
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Ctrl/Cmd + Enter to send message
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    e.preventDefault();
                    sendMessage();
                }
                
                // Ctrl/Cmd + N for new session
                if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                    e.preventDefault();
                    createNewSession();
                }
                
                // Ctrl/Cmd + U for upload
                if ((e.ctrlKey || e.metaKey) && e.key === 'u') {
                    e.preventDefault();
                    toggleDropZone();
                }
                
                // Escape to close modals/dropzone
                if (e.key === 'Escape') {
                    closeDropZone();
                    if (isListening) stopVoiceInput();
                }
            });
        }
        
        // Accessibility features
        function setupAccessibility() {
            // Add focus management
            document.querySelectorAll('.mode-option, .quick-action').forEach(element => {
                element.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        element.click();
                    }
                });
            });
            
            // Announce status changes to screen readers
            const aiStatus = document.getElementById('aiStatus');
            const observer = new MutationObserver(() => {
                aiStatus.setAttribute('aria-live', 'polite');
            });
            observer.observe(aiStatus, { childList: true, subtree: true });
        }
        

        
        function showEmojiPicker() {
            // Simple emoji insertion (can be enhanced with a proper emoji picker)
            const emojis = ['ðŸ˜Š', 'ðŸ¤”', 'ðŸ’¡', 'ðŸ“š', 'âœ¨', 'ðŸŽ¯', 'ðŸš€', 'ðŸ’ª'];
            const randomEmoji = emojis[Math.floor(Math.random() * emojis.length)];
            const input = document.getElementById('messageInput');
            input.value += randomEmoji;
            updateSendButton();
            input.focus();
        }
        
        function showAnalytics() {
            showNotification('Analytics dashboard coming soon!', 'info');
        }
        
        function showVoiceSettings() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content voice-settings-modal">
                    <div class="modal-header">
                        <h3><i class="fas fa-microphone"></i> Voice Settings</h3>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="setting-group">
                            <label>
                                <input type="checkbox" id="voiceAutoSend" ${localStorage.getItem('studymate-voice-auto-send') === 'true' ? 'checked' : ''}>
                                Auto-send after voice input
                            </label>
                        </div>
                        <div class="setting-group">
                            <label>Speech Rate: <span id="rateValue">${localStorage.getItem('studymate-voice-rate') || '0.9'}</span></label>
                            <input type="range" id="voiceRate" min="0.5" max="2" step="0.1" value="${localStorage.getItem('studymate-voice-rate') || '0.9'}">
                        </div>
                        <div class="setting-group">
                            <label>Speech Pitch: <span id="pitchValue">${localStorage.getItem('studymate-voice-pitch') || '1.0'}</span></label>
                            <input type="range" id="voicePitch" min="0.5" max="2" step="0.1" value="${localStorage.getItem('studymate-voice-pitch') || '1.0'}">
                        </div>
                        <div class="setting-group">
                            <label>Speech Volume: <span id="volumeValue">${localStorage.getItem('studymate-voice-volume') || '0.8'}</span></label>
                            <input type="range" id="voiceVolume" min="0" max="1" step="0.1" value="${localStorage.getItem('studymate-voice-volume') || '0.8'}">
                        </div>
                        <div class="setting-group">
                            <button class="btn btn-primary" onclick="testVoice()">
                                <i class="fas fa-play"></i> Test Voice
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Add event listeners
            document.getElementById('voiceAutoSend').addEventListener('change', (e) => {
                localStorage.setItem('studymate-voice-auto-send', e.target.checked);
            });
            
            ['voiceRate', 'voicePitch', 'voiceVolume'].forEach(id => {
                const slider = document.getElementById(id);
                const valueSpan = document.getElementById(id.replace('voice', '').toLowerCase() + 'Value');
                
                slider.addEventListener('input', (e) => {
                    valueSpan.textContent = e.target.value;
                    localStorage.setItem('studymate-voice-' + id.replace('voice', '').toLowerCase(), e.target.value);
                });
            });
            
            // Close on outside click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
        
        function testVoice() {
            if (typeof speakText === 'function') {
                speakText('Hello! This is a test of the StudyMate AI voice system. How does it sound?');
            } else {
                showNotification('Voice synthesis not available', 'error');
            }
        }
        
        // Download notes functionality
        function downloadNotes() {
            const messages = document.querySelectorAll('.message.assistant .message-bubble');
            if (messages.length === 0) {
                showNotification('No notes to download. Start a conversation first!', 'warning');
                return;
            }
            
            let notesContent = `# StudyMate AI - Study Notes\n\n`;
            notesContent += `Generated on: ${new Date().toLocaleDateString()}\n\n`;
            
            messages.forEach((bubble, index) => {
                const content = bubble.textContent.trim();
                if (content && !content.includes('Mode Activated')) {
                    notesContent += `## Note ${index + 1}\n\n${content}\n\n---\n\n`;
                }
            });
            
            // Create and download file
            const blob = new Blob([notesContent], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `StudyMate-Notes-${new Date().toISOString().split('T')[0]}.md`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('Notes downloaded successfully!', 'success');
        }
        
        // Export chat as PDF (simplified version)
        function exportChatAsPDF() {
            showNotification('PDF export feature coming soon! For now, use the markdown download.', 'info');
        }
        
        // Session functions are now handled by sessions.js
        
        // Quick session creation
        function createQuickSession() {
            showSessionNameModal();
        }
        
        // Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/static/sw.js')
                    .then(registration => {
                        console.log('âœ… Service Worker registered');
                    })
                    .catch(error => {
                        console.log('âŒ Service Worker registration failed:', error);
                    });
            });
        }
        
        // Performance monitoring
        window.addEventListener('load', () => {
            if ('performance' in window) {
                const loadTime = performance.timing.loadEventEnd - performance.timing.navigationStart;
                console.log(`âš¡ Page loaded in ${loadTime}ms`);
            }
        });
    </script>
    
    <!-- Loading styles -->
    <style>
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 10, 10, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }
        
        .loading-spinner {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            color: var(--accent-primary);
        }
        
        .loading-spinner i {
            font-size: 3rem;
            animation: pulse 1.5s infinite;
        }
        
        .loading-spinner span {
            font-size: 1.125rem;
            font-weight: 500;
        }
        
        .sidebar-toggle {
            display: none;
            width: 40px;
            height: 40px;
            border: none;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border-radius: var(--radius-md);
            cursor: pointer;
            align-items: center;
            justify-content: center;
            transition: var(--transition-fast);
        }
        
        .sidebar-toggle:hover {
            background: var(--bg-hover);
            color: var(--accent-primary);
        }
        
        @media (max-width: 768px) {
            .sidebar-toggle.mobile-only {
                display: flex;
            }
        }
    </style>
</body>
</html>